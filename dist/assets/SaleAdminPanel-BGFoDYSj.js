import{r,j as e,y as N}from"./index-BrUxmOLQ.js";import X from"./ReceiptViewer-D_fBN0zF.js";import{d as O,u as _,t as U}from"./timezone-JDne8QKb.js";import"./jspdf.es.min-MDSjtU-o.js";const B="https://cel1.onrender.com";function z({onSaleAdded:u,clients:D,products:m}){const[$,I]=r.useState(""),[c,y]=r.useState([]),[x,E]=r.useState(0),[l,C]=r.useState(!1),[h,F]=r.useState(""),[g,s]=r.useState(""),[j,b]=r.useState("17"),[P,p]=r.useState(!1),[f,S]=r.useState(null),[M,w]=r.useState(null);r.useEffect(()=>{let t=0;c.forEach(o=>{var i;const n=o.priceAtSale!==void 0?o.priceAtSale:((i=m.find(d=>d.id===o.productId))==null?void 0:i.price)||0;t+=n*o.quantity}),E(parseFloat(t.toFixed(2)))},[c,m]);const R=()=>{I(""),y([]),E(0),C(!1),F(""),s(""),b("17"),S(null),w(null)},A=t=>{const o=parseInt(t.target.value,10),n=c.some(d=>d.productId===o),i=m.find(d=>d.id===o);o&&i&&!n?(y(d=>[...d,{productId:o,quantity:1,priceAtSale:i.price}]),t.target.value=""):n&&N.warn("Este producto ya ha sido añadido a la venta.")},T=(t,o)=>{const n=parseInt(o,10);y(i=>i.map(d=>d.productId===t?{...d,quantity:n>0?n:1}:d))},q=t=>{y(o=>o.filter(n=>n.productId!==t))},a=async t=>{if(t.preventDefault(),p(!0),S(null),w(null),!$){S("Por favor, selecciona un cliente."),N.error("Cliente es obligatorio."),p(!1);return}if(c.length===0){S("Por favor, añade al menos un producto a la venta."),N.error("Se requiere al menos un producto."),p(!1);return}for(const n of c){const i=m.find(d=>d.id===n.productId);if(i&&n.quantity>i.stock){S(`Stock insuficiente para ${i.name}. Disponible: ${i.stock}, Solicitado: ${n.quantity}.`),N.error(`Stock insuficiente para ${i.name}.`),p(!1);return}}if(l){if(parseInt(j,10)!==17){S("El número de pagos semanales debe ser 17. El backend validará esto."),N.error("Número de pagos semanales debe ser 17."),p(!1);return}if(!h||parseFloat(h)<0){S("El enganche es obligatorio y debe ser un valor positivo para ventas a crédito."),N.error("Enganche obligatorio."),p(!1);return}if(parseFloat(h||0)>x){S("El enganche no puede ser mayor al monto total de la venta."),N.error("Enganche inválido."),p(!1);return}}const o={clientId:parseInt($),saleItems:c.map(n=>({productId:n.productId,quantity:n.quantity,priceAtSale:n.priceAtSale})),totalAmount:x,isCredit:l,downPayment:l?h!==""?parseFloat(h):0:x,interestRate:l&&g!==""?parseFloat(g):0,numberOfPayments:l?parseInt(j,10):null};try{const n=await fetch(`${B}/api/sales`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(o)});if(n.ok){const i=await n.json();w("Venta registrada con éxito!"),N.success("Venta registrada!"),u(i),R()}else{const i=await n.json();throw new Error(i.message||`Error HTTP: ${n.status}`)}}catch(n){console.error("Error al registrar venta:",n),S(n.message||"Error al registrar la venta. Intenta de nuevo."),N.error("Ocurrió un error al registrar la venta.")}finally{p(!1)}},v=parseFloat((x*.1).toFixed(2)),k=x-parseFloat(h||0),L=l&&k>0?parseFloat((k/17).toFixed(2)):0;return e.jsxs("div",{className:"sale-form-container",children:[e.jsx("h2",{children:"Registrar Nueva Venta"}),e.jsxs("form",{onSubmit:a,className:"sale-form",children:[f&&e.jsx("p",{className:"error-message",children:f}),M&&e.jsx("p",{className:"success-message",children:M}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientId",children:"Cliente:"}),e.jsxs("select",{id:"clientId",value:$,onChange:t=>I(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un cliente"}),D.map(t=>e.jsxs("option",{value:t.id,children:[t.name," ",t.lastName," (",t.phone,")"]},t.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"selectProduct",children:"Añadir Producto(s) a la Venta:"}),e.jsxs("select",{id:"selectProduct",onChange:A,value:"",children:[e.jsx("option",{value:"",children:"Selecciona un producto"}),m.map(t=>e.jsxs("option",{value:t.id,disabled:c.some(o=>o.productId===t.id),children:[t.name," - $",t.price," (Stock: ",t.stock,")"]},t.id))]})]}),c.length>0&&e.jsxs("div",{className:"selected-products-list",children:[e.jsx("h3",{children:"Productos en esta Venta:"}),c.map(t=>{const o=m.find(i=>i.id===t.productId),n=t.priceAtSale!==void 0?t.priceAtSale:(o==null?void 0:o.price)||0;return o?e.jsxs("div",{className:"selected-product-item",children:[e.jsx("span",{children:o.name}),e.jsx("input",{type:"number",value:t.quantity,onChange:i=>T(t.productId,i.target.value),min:"1",max:o.stock,required:!0}),e.jsxs("span",{children:["x $",n.toLocaleString("es-MX",{minimumFractionDigits:2})," = ",e.jsxs("strong",{children:["$",(n*t.quantity).toLocaleString("es-MX",{minimumFractionDigits:2})]})]}),e.jsx("button",{type:"button",onClick:()=>q(t.productId),className:"remove-item-button",children:"X"})]},t.productId):null}),e.jsxs("p",{className:"total-amount-display",children:["Monto Total de la Venta: ",e.jsxs("strong",{children:["$",x.toLocaleString("es-MX",{minimumFractionDigits:2})]})]})]},c.map(t=>t.productId).join("-")),e.jsxs("div",{className:"form-group checkbox-group",children:[e.jsx("input",{type:"checkbox",id:"isCredit",checked:l,onChange:t=>C(t.target.checked)}),e.jsx("label",{htmlFor:"isCredit",children:"Venta a Crédito"})]}),l&&e.jsxs("div",{className:"credit-details",children:[e.jsx("h3",{children:"Detalles del Crédito"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"downPayment",children:"Enganche:"}),e.jsx("input",{type:"number",id:"downPayment",value:h,onChange:t=>F(t.target.value),step:"0.01",required:l}),e.jsxs("p",{className:"hint-text",children:["Enganche sugerido (10% del total): ",e.jsxs("strong",{children:["$",v.toLocaleString("es-MX",{minimumFractionDigits:2})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"interestRate",children:"Tasa de Interés Anual (%):"}),e.jsx("input",{type:"number",id:"interestRate",value:g,onChange:t=>s(t.target.value),step:"0.01",required:l}),e.jsx("p",{className:"hint-text",children:"Ej: 0.15 para 15%"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"numberOfPayments",children:"Número de Pagos Semanales (Fijo: 17):"}),e.jsx("input",{type:"number",id:"numberOfPayments",value:j,onChange:t=>b(t.target.value),required:l,min:"17",max:"17",readOnly:!0}),e.jsx("p",{className:"hint-text",children:"El pago semanal se calcula y valida en el servidor dividiendo el saldo entre 17 semanas fijas."})]}),L>0&&e.jsxs("p",{className:"calculated-payment",children:["Pago Semanal Estimado: ",e.jsxs("strong",{children:["$",L.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]}),e.jsx("button",{type:"submit",disabled:P,children:P?"Registrando...":"Registrar Venta"}),e.jsx("button",{type:"button",onClick:R,disabled:P,className:"cancel-button",children:"Limpiar Formulario"})]})]})}O.extend(_);O.extend(U);function H({sales:u,clients:D,products:m,onSaleUpdated:$,onDeleteSale:I,authenticatedFetch:c,userRole:y}){const[x,E]=r.useState(!1),[l,C]=r.useState(null),h=s=>y?Array.isArray(s)?s.includes(y):y===s:!1,F=s=>{C(s),E(!0)},g=()=>{C(null),E(!1)};return u.length===0?e.jsx("p",{children:"No hay ventas registradas."}):e.jsxs("div",{className:"sale-list-container",children:[e.jsx("h2",{children:"Ventas Registradas"}),e.jsxs("table",{className:"sale-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID Venta"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Producto(s)"}),e.jsx("th",{children:"Monto Total"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Enganche"}),e.jsx("th",{children:"Saldo Pendiente"}),e.jsx("th",{children:"Pago Semanal"}),e.jsx("th",{children:"Pagos Restantes"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:u.map(s=>{const j=s.client?`${s.client.name} ${s.client.lastName}`:"N/A",b=s.saleItems&&s.saleItems.length>0?s.saleItems.map(f=>`${f.quantity}x ${f.product?f.product.name:"N/A"}`).join(", "):"N/A",P=s.payments?s.payments.length:0,p=s.isCredit&&s.numberOfPayments?s.numberOfPayments-P:0;return e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:j}),e.jsx("td",{children:b}),e.jsxs("td",{children:["$",s.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsx("td",{children:s.isCredit?"Crédito":"Contado"}),e.jsxs("td",{children:["$",s.downPayment.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("td",{className:s.balanceDue>0?"highlight-balance":"",children:["$",s.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsx("td",{children:s.isCredit?`$${s.weeklyPaymentAmount.toLocaleString("es-MX",{minimumFractionDigits:2})}`:"N/A"}),e.jsx("td",{children:s.isCredit?p:"N/A"}),e.jsx("td",{children:e.jsx("span",{className:`status-badge status-${s.status}`,children:s.status.replace("_"," ")})}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{onClick:()=>F(s),children:"Ver Recibo"}),h("super_admin")&&e.jsx("button",{className:"delete-button",onClick:()=>I(s.id),children:"Eliminar"})]})})]},s.id)})})]}),x&&e.jsx(X,{sale:l,onClose:g})]})}const V="https://cel1.onrender.com";function K({authenticatedFetch:u,onDeleteSale:D,userRole:m}){const[$,I]=r.useState([]),[c,y]=r.useState([]),[x,E]=r.useState([]),[l,C]=r.useState(!0),[h,F]=r.useState(null),[g,s]=r.useState(""),[j,b]=r.useState(1),[P,p]=r.useState(10),[f,S]=r.useState(1),[M,w]=r.useState(0),R=a=>m?Array.isArray(a)?a.includes(m):m===a:!1,A=r.useCallback(async()=>{C(!0),F(null);try{let a=`${V}/api/sales`;g&&(a+=`?search=${encodeURIComponent(g)}`),a+=`${g?"&":"?"}page=${j}&limit=${P}`;const v=await u(a);if(!v.ok){const L=await v.json();throw new Error(L.message||`Error HTTP: ${v.status}`)}const k=await v.json();I(k.sales||[]),S(k.totalPages),w(k.totalItems)}catch(a){console.error("Error al obtener ventas:",a),F(a.message||"No se pudieron cargar las ventas."),I([])}finally{C(!1)}},[u,g,j,P]),T=r.useCallback(async()=>{try{const a=await u(`${V}/api/clients?limit=9999`);if(a.ok){const v=await a.json();y(v.clients||[])}}catch(a){console.error("Error al cargar clientes para ventas:",a)}},[u]),q=r.useCallback(async()=>{try{const a=await u(`${V}/api/products?limit=9999`);if(a.ok){const v=await a.json();E(v.products||[])}}catch(a){console.error("Error al cargar productos para ventas:",a)}},[u]);return r.useEffect(()=>{A(),T(),q()},[A,T,q]),e.jsxs("section",{className:"sales-section",children:[e.jsx("h2",{children:"Gestión de Ventas y Cobranza"}),R(["super_admin","regular_admin","sales_admin"])&&e.jsx(z,{onSaleAdded:A,clients:c,products:x}),e.jsxs("div",{className:"admin-controls",children:[e.jsxs("div",{className:"control-group",children:[e.jsx("label",{htmlFor:"searchSale",children:"Buscar Venta:"}),e.jsx("input",{type:"text",id:"searchSale",value:g,onChange:a=>{s(a.target.value),b(1)},placeholder:"Buscar por ID de venta, cliente o producto..."})]}),e.jsxs("div",{className:"control-group",children:[e.jsx("label",{htmlFor:"itemsPerPage",children:"Ítems por página:"}),e.jsxs("select",{id:"itemsPerPage",value:P,onChange:a=>{p(parseInt(a.target.value,10)),b(1)},children:[e.jsx("option",{value:"5",children:"5"}),e.jsx("option",{value:"10",children:"10"}),e.jsx("option",{value:"20",children:"20"}),e.jsx("option",{value:"50",children:"50"})]})]})]}),l?e.jsx("p",{children:"Cargando ventas..."}):h?e.jsxs("p",{style:{color:"red",fontWeight:"bold"},children:["Error: ",h]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{sales:$,clients:c,products:x,onSaleUpdated:A,onPaymentAdded:A,onDeleteSale:D,authenticatedFetch:u,userRole:m}),f>1&&e.jsxs("div",{className:"pagination-controls",children:[e.jsx("button",{onClick:()=>b(a=>Math.max(a-1,1)),disabled:j===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",j," de ",f," (",M," ítems)"]}),e.jsx("button",{onClick:()=>b(a=>Math.min(a+1,f)),disabled:j===f,children:"Siguiente"})]})]})]})}export{K as default};
