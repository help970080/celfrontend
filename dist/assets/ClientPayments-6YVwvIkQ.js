import{u as te,r as a,y as d,j as e}from"./index-BrUxmOLQ.js";import{d as D,u as ne,t as re}from"./timezone-JDne8QKb.js";import oe from"./ReceiptViewer-D_fBN0zF.js";import"./jspdf.es.min-MDSjtU-o.js";D.extend(ne);D.extend(re);const ie="America/Mexico_City",h="https://cel1.onrender.com";function ue({authenticatedFetch:l,userRole:x}){const{clientId:m}=te(),[c,V]=a.useState(null),[v,z]=a.useState([]),[H,C]=a.useState(!0),[E,A]=a.useState(null),[t,$]=a.useState(null),[Y,M]=a.useState(!1),[j,y]=a.useState(""),[f,b]=a.useState("cash"),[S,N]=a.useState(""),[P,k]=a.useState(!1),[R,o]=a.useState(null),[q,F]=a.useState(!1),[T,L]=a.useState(null),[u,B]=a.useState(null),[J,O]=a.useState(!0),[I,X]=a.useState(null),G=s=>x?Array.isArray(s)?s.includes(x):x===s:!1,w=a.useCallback(async()=>{C(!0),A(null),O(!0),X(null);try{const s=await l(`${h}/api/clients/${m}`);if(!s.ok){const i=await s.json();throw new Error(i.message||`Error HTTP: ${s.status}`)}const n=await s.json();V(n);const r=await l(`${h}/api/reports/client-statement/${m}`);if(!r.ok){const i=await r.json();throw new Error(i.message||`Error HTTP: ${r.status}`)}const se=(await r.json()).sales.filter(i=>i.isCredit);z(se);const p=await l(`${h}/api/reports/client-risk/${m}`);if(!p.ok){const i=await p.json();throw new Error(i.message||`Error HTTP: ${p.status}`)}const ae=await p.json();B(ae)}catch(s){console.error("Error al cargar datos del cliente o análisis de riesgo:",s),A(s.message||"No se pudieron cargar los datos del cliente o el análisis de riesgo."),X(s.message||"No se pudo cargar el análisis de riesgo.")}finally{C(!1),O(!1)}},[m,l]);a.useEffect(()=>{w()},[w]);const U=s=>{$(s),M(!0),y(s.weeklyPaymentAmount>0?s.weeklyPaymentAmount.toFixed(2):""),b("cash"),N(""),o(null)},g=()=>{$(null),M(!1),W(),w()},W=()=>{y(""),b("cash"),N(""),k(!1),o(null)},Z=a.useCallback(async s=>{if(s.preventDefault(),!t||!t.id){o("No se ha proporcionado una venta válida para registrar el pago."),d.error("Error: Venta inválida para pago.");return}const n=parseFloat(j);if(isNaN(n)||n<=0){o("Por favor, ingresa un monto de pago válido mayor a cero."),d.error("Monto de pago inválido.");return}if(n>t.balanceDue){o(`El monto del pago ($${n.toLocaleString("es-MX",{minimumFractionDigits:2})}) no puede ser mayor al saldo pendiente de $${t.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2})}.`),d.error("Monto de pago excede el saldo pendiente.");return}k(!0),o(null);try{const r=await l(`${h}/api/sales/${t.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:n,paymentMethod:f,notes:S})});if(!r.ok){const _=await r.json();throw new Error(_.message||`Error HTTP: ${r.status}`)}d.success("Pago registrado con éxito!"),g()}catch(r){console.error("Error al registrar pago:",r),o(r.message||"Error al registrar el pago. Intenta de nuevo."),d.error("Ocurrió un error al registrar el pago.")}finally{k(!1)}},[t,j,f,S,l,g]),K=s=>{L(s),F(!0)},Q=()=>{L(null),F(!1)};if(H)return e.jsx("section",{className:"client-payments-section",children:"Cargando cobranza y análisis de riesgo del cliente..."});if(E)return e.jsx("section",{className:"client-payments-section",children:e.jsxs("p",{className:"error-message",children:["Error: ",E]})});if(!c)return e.jsx("section",{className:"client-payments-section",children:e.jsx("p",{children:"Cliente no encontrado."})});const ee=s=>{switch(s){case"BAJO":return"risk-badge risk-low";case"MEDIO":return"risk-badge risk-medium";case"ALTO":return"risk-badge risk-high";default:return"risk-badge risk-unknown"}};return e.jsxs("section",{className:"client-payments-section",children:[e.jsxs("h2",{children:["Gestión de Cobranza para ",c.name," ",c.lastName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Teléfono:"})," ",c.phone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",c.email||"N/A"]}),e.jsx("hr",{}),e.jsx("h3",{children:"Análisis de Riesgo de Crédito:"}),J?e.jsx("p",{children:"Cargando análisis de riesgo..."}):I?e.jsxs("p",{className:"error-message",children:["Error al cargar riesgo: ",I]}):u?e.jsxs("div",{className:"risk-analysis-card",children:[e.jsxs("p",{children:["Categoría de Riesgo: ",e.jsx("span",{className:ee(u.riskCategory),children:u.riskCategory})]}),e.jsx("p",{children:u.riskDetails})]}):e.jsx("p",{children:"No se pudo realizar el análisis de riesgo."}),e.jsx("hr",{}),e.jsx("h3",{children:"Historial de Ventas a Crédito:"}),v.length===0?e.jsx("p",{children:"Este cliente no tiene ventas a crédito registradas."}):e.jsx("div",{className:"credit-sales-list",children:v.map(s=>e.jsxs("div",{className:"credit-sale-card",children:[e.jsxs("h4",{children:["Venta #",s.id," - ",D(s.saleDate).tz(ie).format("DD/MM/YYYY")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Producto(s):"})," ",s.saleItems&&s.saleItems.map(n=>n.product?`${n.product.name} (x${n.quantity})`:`Producto ID ${n.productId} (x${n.quantity})`).join(", ")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Monto Original:"})," $",s.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Enganche:"})," $",s.downPayment.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{className:s.balanceDue>0?"highlight-balance":"",children:[e.jsx("strong",{children:"Saldo Pendiente:"})," $",s.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2}),s.balanceDue<=0&&e.jsx("span",{style:{color:"green",marginLeft:"5px",fontWeight:"bold"},children:"(Pagada)"})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Pago Semanal:"})," $",s.weeklyPaymentAmount.toLocaleString("es-MX",{minimumFractionDigits:2})," (",s.numberOfPayments," pagos)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Tasa Interés:"})," ",s.interestRate*100,"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Estado:"})," ",e.jsx("span",{className:`status-badge status-${s.status}`,children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"card-actions",children:[s.balanceDue>0&&s.status!=="paid_off"&&G(["super_admin","regular_admin","sales_admin"])&&e.jsx("button",{onClick:()=>U(s),className:"action-button",children:"Registrar Abono"}),e.jsx("button",{onClick:()=>K(s),className:"action-button secondary-button",children:"Ver Recibo"})]})]},s.id))}),Y&&t&&e.jsx("div",{className:"payment-form-modal-overlay",children:e.jsxs("div",{className:"payment-form-modal-content",children:[e.jsx("button",{className:"close-button",onClick:g,children:"×"}),e.jsxs("h3",{children:["Registrar Abono para Venta #",t.id]}),e.jsxs("div",{className:"payment-summary-info",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Saldo Venta Original:"})," $",t.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{className:"highlight-balance",children:[e.jsx("strong",{children:"Saldo Pendiente:"})," $",t.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2})]}),t.weeklyPaymentAmount>0&&e.jsxs("p",{children:[e.jsx("strong",{children:"Pago Semanal Sugerido:"})," $",t.weeklyPaymentAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]})]}),e.jsxs("form",{onSubmit:Z,className:"payment-form-inner",children:[R&&e.jsx("p",{className:"error-message",children:R}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"abonoAmount",children:"Monto del Abono:"}),e.jsx("input",{type:"number",id:"abonoAmount",value:j,onChange:s=>y(s.target.value),step:"0.01",min:"0.01",max:t.balanceDue,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"abonoMethod",children:"Método de Pago:"}),e.jsxs("select",{id:"abonoMethod",value:f,onChange:s=>b(s.target.value),children:[e.jsx("option",{value:"cash",children:"Efectivo"}),e.jsx("option",{value:"transfer",children:"Transferencia"}),e.jsx("option",{value:"card",children:"Tarjeta"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"abonoNotes",children:"Notas (Opcional):"}),e.jsx("input",{type:"text",id:"abonoNotes",value:S,onChange:s=>N(s.target.value)})]}),e.jsx("button",{type:"submit",disabled:P,children:P?"Registrando...":"Confirmar Abono"}),e.jsx("button",{type:"button",onClick:g,disabled:P,className:"cancel-button",children:"Cancelar"})]})]})}),q&&T&&e.jsx(oe,{sale:T,onClose:Q})]})}export{ue as default};
