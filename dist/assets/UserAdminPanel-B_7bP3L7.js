import{r,j as e,y as l}from"./index-D3s1T9TP.js";import{d as f,u as R,t as B}from"./timezone-D8uTpChD.js";f.extend(R);f.extend(B);const F="America/Mexico_City",p="https://cel1.onrender.com";function K({authenticatedFetch:c,userRole:u}){const[A,P]=r.useState([]),[Y,g]=r.useState(!0),[D,b]=r.useState(null),[a,T]=r.useState(null),[E,N]=r.useState(!1),[y,U]=r.useState(""),[d,S]=r.useState(""),[m,v]=r.useState(""),[w,h]=r.useState(!1),[_,n]=r.useState(null),[$,x]=r.useState(null),k=["super_admin","regular_admin","sales_admin","inventory_admin","viewer_reports"],C=r.useCallback(s=>u?Array.isArray(s)?s.includes(u):u===s:!1,[u]),j=r.useCallback(async()=>{g(!0),b(null);try{const s=await c(`${p}/api/users`);if(!s.ok){const i=await s.json();throw new Error(i.message||`Error HTTP: ${s.status}`)}const t=await s.json();P(t)}catch(s){console.error("Error al obtener usuarios:",s),b(s.message||"No se pudieron cargar los usuarios.")}finally{g(!1)}},[c]);r.useEffect(()=>{C("super_admin")?j():(g(!1),b("Acceso denegado. Solo super administradores pueden gestionar usuarios."))},[j,C]);const L=async s=>{if(s.preventDefault(),h(!0),n(null),x(null),!y||!m||a===null&&!d){n("Nombre de usuario, rol y contraseña (para nuevo usuario) son obligatorios."),h(!1);return}if(!k.includes(m)){n("El rol seleccionado no es válido."),h(!1);return}const t={username:y,role:m};d&&(t.password=d);const i=a?`${p}/api/users/${a.id}`:`${p}/api/users`,G=a?"PUT":"POST";try{const o=await c(i,{method:G,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const O=await o.json();throw new Error(O.message||`Error HTTP: ${o.status}`)}const H=await o.json();x(a?"Usuario actualizado con éxito!":"Usuario creado con éxito!"),l.success(a?"Usuario actualizado!":"Usuario creado!"),I(),j()}catch(o){console.error("Error al guardar usuario:",o),n(o.message||"Error al guardar el usuario. Intenta de nuevo."),l.error("Ocurrió un error al guardar el usuario.")}finally{h(!1)}},I=()=>{U(""),S(""),v(""),T(null),N(!1),n(null),x(null)},M=s=>{T(s),U(s.username),v(s.role),S(""),N(!0),n(null),x(null)},z=parseInt(localStorage.getItem("userId"),10),q=async(s,t)=>{if(s===z){l.error("No puedes eliminar tu propia cuenta a través de esta interfaz.");return}if(window.confirm(`¿Estás seguro de que quieres eliminar al usuario "${t}"?`))try{await c(`${p}/api/users/${s}`,{method:"DELETE"}),l.success("Usuario eliminado con éxito!"),j()}catch(i){console.error("Error al eliminar usuario:",i),l.error(`Error al eliminar el usuario: ${i.message||"Error desconocido."}`)}};return C("super_admin")?Y?e.jsxs("section",{className:"user-admin-section",children:[e.jsx("h2",{children:"Gestión de Usuarios"}),e.jsx("p",{children:"Cargando usuarios..."})]}):D?e.jsxs("section",{className:"user-admin-section",children:[e.jsx("h2",{children:"Gestión de Usuarios"}),e.jsxs("p",{className:"error-message",children:["Error: ",D]})]}):e.jsxs("section",{className:"user-admin-section",children:[e.jsx("h2",{children:"Gestión de Usuarios"}),e.jsx("button",{onClick:()=>N(!E),className:"action-button primary-button",style:{marginBottom:"20px"},children:E?"Ocultar Formulario":"Agregar Nuevo Usuario"}),E&&e.jsxs("div",{className:"user-form-container",children:[e.jsx("h3",{children:a?"Editar Usuario":"Crear Nuevo Usuario"}),e.jsxs("form",{onSubmit:L,className:"user-form",children:[_&&e.jsx("p",{className:"error-message",children:_}),$&&e.jsx("p",{className:"success-message",children:$}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"username",children:"Nombre de Usuario:"}),e.jsx("input",{type:"text",id:"username",value:y,onChange:s=>U(s.target.value),required:!0,disabled:a&&a.role==="super_admin"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"password",children:["Contraseña ",a?"(dejar en blanco para no cambiar)":"*",":"]}),e.jsx("input",{type:"password",id:"password",value:d,onChange:s=>S(s.target.value),required:a===null})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"role",children:"Rol:"}),e.jsxs("select",{id:"role",value:m,onChange:s=>v(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un rol"}),k.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsx("button",{type:"submit",disabled:w,children:w?"Guardando...":a?"Actualizar Usuario":"Crear Usuario"}),a&&e.jsx("button",{type:"button",onClick:I,disabled:w,className:"cancel-button",children:"Cancelar Edición"})]})]}),e.jsx("h3",{children:"Usuarios Existentes"}),A.length===0?e.jsx("p",{children:"No hay usuarios registrados."}):e.jsxs("table",{className:"user-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Usuario"}),e.jsx("th",{children:"Rol"}),e.jsx("th",{children:"Creado"}),e.jsx("th",{children:"Actualizado"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:A.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:s.username}),e.jsx("td",{children:e.jsx("span",{className:`status-badge status-${s.role}`,children:s.role})}),e.jsx("td",{children:f(s.createdAt).tz(F).format("DD/MM/YYYY")}),e.jsx("td",{children:f(s.updatedAt).tz(F).format("DD/MM/YYYY")}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{onClick:()=>M(s),children:"Editar"}),s.id!==z&&e.jsx("button",{className:"delete-button",onClick:()=>q(s.id,s.username),children:"Eliminar"})]})})]},s.id))})]})]}):e.jsxs("section",{className:"user-admin-section",children:[e.jsx("h2",{children:"Gestión de Usuarios"}),e.jsx("p",{className:"error-message",children:"Acceso denegado. Solo los Super Administradores pueden gestionar usuarios."})]})}export{K as default};
