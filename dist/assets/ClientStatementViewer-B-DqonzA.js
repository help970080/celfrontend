import{u as b,r,j as e,y as i}from"./index-D3s1T9TP.js";import{d as o,u as F,t as L}from"./timezone-D8uTpChD.js";import{h as T,E as Y}from"./jspdf.es.min-zq-KNx7Z.js";o.extend(F);o.extend(L);const j="America/Mexico_City",_="https://cel1.onrender.com";function X({authenticatedFetch:g}){const{clientId:f}=b(),[s,y]=r.useState(null),[c,P]=r.useState([]),[h,M]=r.useState(0),[v,D]=r.useState(!0),[C,S]=r.useState(null),u=r.useRef(),E="CelExpress Pro, Powered by Leonardo Luna",d={name:"Celexpress Tu Tienda de Celulares",address:"Morelos Sn.Col.Centro, Juchitepec,EdoMex",phone:"56 6548 9522",email:"contacto@tuempresa.com"},$=r.useCallback(async()=>{D(!0),S(null);try{const t=await g(`${_}/api/reports/client-statement/${f}`);if(!t.ok){const a=await t.json();throw new Error(a.message||`Error HTTP: ${t.status}`)}const n=await t.json();y(n.client),P(n.sales),M(n.totalClientBalanceDue)}catch(t){console.error("Error al obtener estado de cuenta:",t),S(t.message||"No se pudo cargar el estado de cuenta.")}finally{D(!1)}},[g,f]);r.useEffect(()=>{$()},[$]);const A=async()=>{if(!u.current){i.error("No se pudo capturar el contenido del estado de cuenta.");return}i.info("Generando PDF del estado de cuenta...");try{const t=await T(u.current,{scale:2}),n=t.toDataURL("image/png"),a=new Y("p","mm","a4"),p=210,N=297,l=t.height*p/t.width;let m=l,x=0;for(a.addImage(n,"PNG",0,x,p,l),m-=N;m>=0;)x=m-l,a.addPage(),a.addImage(n,"PNG",0,x,p,l),m-=N;a.save(`estado_cuenta_${s.name.replace(/\s/g,"_")}_${s.lastName.replace(/\s/g,"_")}.pdf`),i.success("Estado de cuenta PDF generado con éxito!")}catch(t){console.error("Error al generar PDF del estado de cuenta:",t),i.error("Error al generar el estado de cuenta PDF.")}},w=()=>{const t=s?s.phone:"";if(!t){i.error("El cliente no tiene un número de teléfono registrado.");return}const n=`¡Hola ${s.name}! Aquí tienes tu estado de cuenta de ${E}. Saldo pendiente total: $${h.toLocaleString("es-MX",{minimumFractionDigits:2})}.`;window.open(`https://wa.me/${t}?text=${encodeURIComponent(n)}`,"_blank"),i.info("Se abrió WhatsApp con el mensaje. Adapta el mensaje si es necesario.")},I=()=>{const t=s?s.phone:"";if(!t){i.error("El cliente no tiene un número de teléfono registrado.");return}const n=`Estado de cuenta ${E}. Saldo pendiente: $${h.toLocaleString("es-MX",{minimumFractionDigits:2})}.`;window.open(`sms:${t}?body=${encodeURIComponent(n)}`,"_blank"),i.info("Se abrió la aplicación de SMS. Adapta el mensaje si es necesario.")};return v?e.jsx("p",{children:"Cargando estado de cuenta..."}):C?e.jsxs("p",{className:"error-message",children:["Error al cargar estado de cuenta: ",C]}):s?e.jsxs("div",{className:"client-statement-container",children:[e.jsxs("h2",{children:["Estado de Cuenta Detallado de ",s.name," ",s.lastName]}),e.jsxs("div",{className:"statement-actions",children:[e.jsx("button",{onClick:A,children:"Descargar Estado de Cuenta (PDF)"}),e.jsx("button",{onClick:w,children:"Compartir por WhatsApp"}),e.jsx("button",{onClick:I,children:"Compartir por SMS"})]}),e.jsxs("div",{ref:u,className:"statement-body",children:[e.jsxs("div",{className:"statement-header",children:[e.jsxs("h2",{children:[d.name," - Estado de Cuenta"]}),e.jsx("p",{children:d.address}),e.jsxs("p",{children:["Tel: ",d.phone," | Email: ",d.email]}),e.jsxs("p",{children:["Fecha de Emisión: ",o().tz(j).format("DD/MM/YYYY HH:mm")]})," ",e.jsx("hr",{})]}),e.jsxs("div",{className:"statement-client-info",children:[e.jsx("h3",{children:"Datos del Cliente"}),e.jsxs("p",{children:[e.jsx("strong",{children:"Nombre:"})," ",s.name," ",s.lastName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Teléfono:"})," ",s.phone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",s.email||"N/A"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Dirección:"})," ",`${s.address}, ${s.city||"N/A"}, ${s.state||"N/A"}, ${s.zipCode||"N/A"}`]}),e.jsxs("p",{children:[e.jsx("strong",{children:"ID Identificación:"})," ",s.identificationId||"N/A"]}),e.jsx("hr",{})]}),e.jsx("h3",{children:"Resumen de Créditos Activos"}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Saldo Pendiente Total"}),e.jsxs("p",{children:["$",h.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Total Ventas (Este Cliente)"}),e.jsx("p",{children:c.length})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Total Pagos (Este Cliente)"}),e.jsx("p",{children:c.reduce((t,n)=>t+(n.payments?n.payments.length:0),0)})]})]}),e.jsx("hr",{}),e.jsx("h3",{children:"Detalle de Ventas y Movimientos"}),c.length===0?e.jsx("p",{children:"Este cliente no tiene ventas registradas."}):c.map(t=>e.jsxs("div",{className:"sale-movement-card",children:[e.jsxs("h4",{children:["Venta #",t.id," - ",o(t.saleDate).tz(j).format("DD/MM/YYYY")]})," ",e.jsxs("p",{children:[e.jsx("strong",{children:"Monto Venta:"})," $",t.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Tipo:"})," ",t.isCredit?"Crédito":"Contado"]}),e.jsx("p",{children:e.jsx("strong",{children:"Producto(s):"})}),e.jsx("ul",{className:"statement-product-list",children:t.saleItems&&t.saleItems.length>0?t.saleItems.map((n,a)=>e.jsx("li",{children:n.product?`${n.product.name} (x${n.quantity})`:`Producto ID ${n.productId} (x${n.quantity})`},n.id||a)):e.jsx("li",{children:"N/A"})}),t.isCredit&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Enganche:"})," $",t.downPayment.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Saldo Venta Actual:"})," $",t.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Pago Semanal:"})," $",t.weeklyPaymentAmount.toLocaleString("es-MX",{minimumFractionDigits:2})," (",t.numberOfPayments," pagos)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Tasa Interés:"})," ",t.interestRate*100,"%"]})]}),t.payments&&t.payments.length>0&&e.jsxs("div",{className:"payments-detail",children:[e.jsx("h5",{children:"Historial de Pagos de esta Venta:"}),e.jsx("ul",{children:t.payments.map(n=>e.jsxs("li",{children:[o(n.paymentDate).tz(j).format("DD/MM/YYYY HH:mm")," - $",n.amount.toLocaleString("es-MX",{minimumFractionDigits:2})," (",n.paymentMethod,") - ",n.notes||""," "]},n.id))})]}),e.jsx("hr",{})]},t.id))]})]}):e.jsx("p",{children:"Cliente no encontrado o ID inválido."})}export{X as default};
