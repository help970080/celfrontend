import{r as t,j as e}from"./index-D3s1T9TP.js";import{d as m,u as oe,t as ce}from"./timezone-D8uTpChD.js";m.extend(oe);m.extend(ce);const y="America/Mexico_City",j="https://cel1.onrender.com";function le({authenticatedFetch:o}){const[x,X]=t.useState(null),[S,O]=t.useState([]),[_,f]=t.useState(!0),[A,P]=t.useState(null),[d,q]=t.useState(m().tz(y).format("YYYY-MM-DD")),[i,B]=t.useState(m().tz(y).format("YYYY-MM-DD")),[b,Z]=t.useState([]),[$,G]=t.useState([]),[J,E]=t.useState(!1),[v,w]=t.useState(null),[M,K]=t.useState([]),[R,Q]=t.useState([]),[c,W]=t.useState("day"),[ee,T]=t.useState(!1),[I,Y]=t.useState(null),[p,se]=t.useState(""),[g,te]=t.useState(""),[D,ae]=t.useState(null),[re,k]=t.useState(!1),[L,U]=t.useState(null),V=t.useCallback(async()=>{f(!0),P(null);try{const s=await o(`${j}/api/reports/summary`);if(!s.ok){const n=await s.json();throw new Error(n.message||`Error HTTP: ${s.status}`)}const a=await s.json();X(a);const r=await o(`${j}/api/reports/pending-credits`);if(!r.ok){const n=await r.json();throw new Error(n.message||`Error HTTP: ${r.status}`)}const l=await r.json();O(l)}catch(s){console.error("Error al cargar datos de resumen/pendientes:",s),P(s.message||"No se pudieron cargar el resumen o los créditos pendientes.")}finally{f(!1)}},[o]),C=t.useCallback(async()=>{E(!0),w(null);try{const s=`${j}/api/reports/sales-by-date-range?startDate=${encodeURIComponent(d)}&endDate=${encodeURIComponent(i)}`,a=`${j}/api/reports/payments-by-date-range?startDate=${encodeURIComponent(d)}&endDate=${encodeURIComponent(i)}`,r=await o(s);if(!r.ok){const u=await r.json();throw new Error(u.message||`Error HTTP: ${r.status}`)}const l=await r.json();Z(l);const n=await o(a);if(!n.ok){const u=await n.json();throw new Error(u.message||`Error HTTP: ${n.status}`)}const h=await n.json();G(h)}catch(s){console.error("Error al cargar reportes diarios:",s),w(s.message||"No se pudieron cargar los reportes diarios.")}finally{E(!1)}},[o,d,i]),N=t.useCallback(async()=>{T(!0),Y(null);try{let s=`${j}/api/reports/sales-accumulated?period=${encodeURIComponent(c)}`,a=`${j}/api/reports/payments-accumulated?period=${encodeURIComponent(c)}`;p&&g&&(s+=`&startDate=${encodeURIComponent(p)}&endDate=${encodeURIComponent(g)}`,a+=`&startDate=${encodeURIComponent(p)}&endDate=${encodeURIComponent(g)}`);const r=await o(s);if(!r.ok){const u=await r.json();throw new Error(u.message||`Error HTTP: ${r.status}`)}const l=await r.json();K(l);const n=await o(a);if(!n.ok){const u=await n.json();throw new Error(u.message||`Error HTTP: ${n.status}`)}const h=await n.json();Q(h)}catch(s){console.error("Error al cargar reportes acumulados:",s),Y(s.message||"No se pudieron cargar los reportes acumulados.")}finally{T(!1)}},[o,c,p,g]),H=t.useCallback(async()=>{k(!0),U(null);try{const s=await o(`${j}/api/reports/client-status-dashboard`);if(!s.ok){const r=await s.json();throw new Error(r.message||`Error HTTP: ${s.status}`)}const a=await s.json();ae(a)}catch(s){console.error("Error al cargar dashboard de clientes:",s),U(s.message||"No se pudo cargar el dashboard de clientes.")}finally{k(!1)}},[o]);t.useEffect(()=>{V(),C(),H(),N()},[V,C,H,N]);const z=(s,a)=>{a==="start"?q(s.target.value):B(s.target.value)};t.useEffect(()=>{d&&i&&C()},[d,i,C]);const ne=s=>{W(s.target.value)},F=(s,a)=>{a==="start"?se(s.target.value):te(s.target.value)};return t.useEffect(()=>{N()},[c,p,g,N]),_?e.jsx("p",{children:"Cargando reportes..."}):A?e.jsxs("p",{className:"error-message",children:["Error al cargar reportes: ",A]}):e.jsxs("div",{className:"reports-dashboard",children:[e.jsx("h2",{children:"Resumen Financiero"}),x?e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Saldo Pendiente Total"}),e.jsxs("p",{children:["$",x.totalBalanceDue.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Créditos Activos"}),e.jsx("p",{children:x.activeCreditSalesCount})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Pagos Recibidos Total"}),e.jsxs("p",{children:["$",x.totalPaymentsReceived.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Total Clientes"}),e.jsx("p",{children:x.totalClientsCount})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"Total Ventas"}),e.jsx("p",{children:x.totalSalesCount})]})]}):e.jsx("p",{children:"No hay datos de resumen disponibles."}),e.jsx("h2",{style:{marginTop:"40px"},children:"Estado de Clientes por Cobranza"}),re?e.jsx("p",{children:"Cargando estado de clientes..."}):L?e.jsxs("p",{className:"error-message",children:["Error: ",L]}):D?e.jsxs("div",{className:"client-status-cards",children:[e.jsxs("div",{className:"status-card current",children:[e.jsx("h3",{children:"Al Corriente"}),e.jsx("p",{children:D.alCorriente})]}),e.jsxs("div",{className:"status-card due-soon",children:[e.jsx("h3",{children:"Por Vencer"}),e.jsx("p",{children:D.porVencer})]}),e.jsxs("div",{className:"status-card overdue",children:[e.jsx("h3",{children:"Vencidos"}),e.jsx("p",{children:D.vencidos})]}),e.jsxs("div",{className:"status-card paid-off",children:[e.jsx("h3",{children:"Pagados"}),e.jsx("p",{children:D.pagados})]}),e.jsxs("div",{className:"status-card active-total",children:[e.jsx("h3",{children:"Total Créditos Activos"}),e.jsx("p",{children:D.totalActivos})]})]}):e.jsx("p",{children:"No hay datos de estado de clientes disponibles."}),e.jsx("h2",{style:{marginTop:"40px"},children:"Reporte de Transacciones por Rango de Fechas"}),e.jsxs("div",{className:"daily-report-controls",children:[e.jsx("label",{htmlFor:"startDate",children:"Desde:"}),e.jsx("input",{type:"date",id:"startDate",value:d,onChange:s=>z(s,"start"),max:m().tz(y).format("YYYY-MM-DD")}),e.jsx("label",{htmlFor:"endDate",children:"Hasta:"}),e.jsx("input",{type:"date",id:"endDate",value:i,onChange:s=>z(s,"end"),max:m().tz(y).format("YYYY-MM-DD")}),e.jsx("button",{onClick:C,className:"refresh-button",children:"Actualizar Rango"})]}),J?e.jsx("p",{children:"Cargando transacciones..."}):v?e.jsxs("p",{className:"error-message",children:["Error: ",v]}):e.jsxs("div",{className:"daily-reports-content",children:[e.jsxs("h3",{children:["Ventas del Rango ",d," al ",i]}),b.length===0?e.jsx("p",{children:"No hay ventas registradas para este rango de fechas."}):e.jsxs("table",{className:"daily-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID Venta"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Productos Vendidos"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Fecha Venta"})]})}),e.jsx("tbody",{children:b.map(s=>{const a=s.client?`${s.client.name} ${s.client.lastName}`:"N/A",r=s.saleItems&&s.saleItems.length>0?s.saleItems.map(l=>l.product?`${l.product.name} (x${l.quantity})`:`Producto ID ${l.productId}`).join(", "):"N/A";return e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:a}),e.jsx("td",{children:r}),e.jsxs("td",{children:["$",s.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsx("td",{children:s.isCredit?"Crédito":"Contado"}),e.jsx("td",{children:m(s.saleDate).tz(y).format("DD/MM/YYYY HH:mm")})]},s.id)})})]}),e.jsxs("h3",{style:{marginTop:"30px"},children:["Pagos del Rango ",d," al ",i," (Cierre de Caja)"]}),$.length===0?e.jsx("p",{children:"No hay pagos registrados para esta fecha."}):e.jsxs("table",{className:"daily-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID Pago"}),e.jsx("th",{children:"ID Venta"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Monto Pagado"}),e.jsx("th",{children:"Método"}),e.jsx("th",{children:"Notas"}),e.jsx("th",{children:"Fecha Pago"})]})}),e.jsx("tbody",{children:$.map(s=>(s.sale&&s.sale.client&&`${s.sale.client.name}${s.sale.client.lastName}`,e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:s.sale?s.sale.id:"N/A"}),e.jsxs("td",{children:["$",s.amount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsx("td",{children:s.paymentMethod||"N/A"}),e.jsx("td",{children:s.notes||"N/A"}),e.jsx("td",{children:m(s.paymentDate).tz(y).format("DD/MM/YYYY HH:mm")})]},s.id)))})]})]}),e.jsx("h2",{style:{marginTop:"40px"},children:"Ventas y Pagos Acumulados por Período"}),e.jsxs("div",{className:"accumulated-controls",children:[e.jsx("label",{htmlFor:"accumulatedPeriod",children:"Acumular por:"}),e.jsxs("select",{id:"accumulatedPeriod",value:c,onChange:ne,children:[e.jsx("option",{value:"day",children:"Día"}),e.jsx("option",{value:"week",children:"Semana"}),e.jsx("option",{value:"month",children:"Mes"}),e.jsx("option",{value:"year",children:"Año"})]}),e.jsx("label",{htmlFor:"accStartDate",children:"Desde:"}),e.jsx("input",{type:"date",id:"accStartDate",value:p,onChange:s=>F(s,"start")}),e.jsx("label",{htmlFor:"accEndDate",children:"Hasta:"}),e.jsx("input",{type:"date",id:"accEndDate",value:g,onChange:s=>F(s,"end")}),e.jsx("button",{onClick:N,className:"refresh-button",children:"Actualizar Acumulados"})]}),ee?e.jsx("p",{children:"Cargando reportes acumulados..."}):I?e.jsxs("p",{className:"error-message",children:["Error: ",I]}):e.jsxs("div",{className:"accumulated-reports-content",children:[e.jsxs("h3",{children:["Ventas Acumuladas por ",c==="day"?"Día":c==="week"?"Semana":c==="month"?"Mes":"Año"]}),M.length===0?e.jsx("p",{children:"No hay ventas acumuladas para este período o rango."}):e.jsxs("table",{className:"daily-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Período"}),e.jsx("th",{children:"Total Monto Vendido"}),e.jsx("th",{children:"# Ventas"})]})}),e.jsx("tbody",{children:M.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{children:s[c]}),e.jsxs("td",{children:["$",s.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsx("td",{children:s.count})]},a))})]}),e.jsxs("h3",{style:{marginTop:"30px"},children:["Pagos Acumulados por ",c==="day"?"Día":c==="week"?"Semana":c==="month"?"Mes":"Año"]}),R.length===0?e.jsx("p",{children:"No hay pagos acumulados para este período o rango."}):e.jsxs("table",{className:"daily-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Período"}),e.jsx("th",{children:"Total Monto Pagado"}),e.jsx("th",{children:"# Pagos"})]})}),e.jsx("tbody",{children:R.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{children:s[c]}),e.jsxs("td",{children:["$",s.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsx("td",{children:s.count})]},a))})]})]}),e.jsx("h2",{style:{marginTop:"40px"},children:"Créditos con Saldo Pendiente"}),S.length===0?e.jsx("p",{children:"No hay créditos pendientes de cobro."}):e.jsxs("table",{className:"pending-credits-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID Venta"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Producto(s)"}),e.jsx("th",{children:"Monto Original"}),e.jsx("th",{children:"Enganche"}),e.jsx("th",{children:"Saldo Actual"}),e.jsx("th",{children:"Pago Semanal"}),e.jsx("th",{children:"Pagos Realizados"}),e.jsx("th",{children:"Pagos Restantes"}),e.jsx("th",{children:"Estado"})]})}),e.jsx("tbody",{children:S.map(s=>{const a=s.client?`${s.client.name} ${s.client.lastName}`:"N/A",r=s.saleItems&&s.saleItems.length>0?s.saleItems.map(h=>h.product?`${h.product.name} (x${h.quantity})`:`Producto ID ${h.productId}`).join(", "):"N/A",l=s.payments?s.payments.length:0,n=s.numberOfPayments?s.numberOfPayments-l:0;return e.jsxs("tr",{children:[e.jsx("td",{children:s.id}),e.jsx("td",{children:a}),e.jsx("td",{children:r}),e.jsxs("td",{children:["$",s.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("td",{children:["$",s.downPayment.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("td",{className:s.balanceDue>0?"highlight-balance":"",children:["$",s.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsx("td",{children:s.isCredit?`$${s.weeklyPaymentAmount.toLocaleString("es-MX",{minimumFractionDigits:2})}`:"N/A"}),e.jsx("td",{children:l}),e.jsx("td",{children:n>=0?n:"N/A"}),e.jsx("td",{children:e.jsx("span",{className:`status-badge status-${s.status}`,children:s.status.replace("_"," ")})})]},s.id)})})]})]})}function he({authenticatedFetch:o}){return e.jsxs("section",{className:"reports-section",children:[e.jsx("h2",{children:"Dashboard y Reportes"}),e.jsx(le,{authenticatedFetch:o})]})}export{he as default};
