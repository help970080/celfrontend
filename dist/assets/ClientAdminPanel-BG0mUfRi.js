import{r as n,j as e,y as I,L as z}from"./index-BrUxmOLQ.js";const R="https://cel1.onrender.com";function Z({onClientAdded:u,clientToEdit:a,setClientToEdit:c}){const[m,i]=n.useState(""),[r,v]=n.useState(""),[A,b]=n.useState(""),[E,N]=n.useState(""),[h,w]=n.useState(""),[x,p]=n.useState(""),[y,_]=n.useState(""),[j,$]=n.useState(""),[k,F]=n.useState(""),[g,f]=n.useState(""),[L,t]=n.useState(!1),[l,o]=n.useState(null),[S,P]=n.useState(null);n.useEffect(()=>{a?(i(a.name||""),v(a.lastName||""),b(a.phone||""),N(a.email||""),w(a.address||""),p(a.city||""),_(a.state||""),$(a.zipCode||""),F(a.identificationId||""),f(a.notes||"")):d()},[a]);const d=()=>{i(""),v(""),b(""),N(""),w(""),p(""),_(""),$(""),F(""),f(""),o(null),P(null),c&&c(null)},D=async s=>{s.preventDefault(),t(!0),o(null),P(null);const U={name:m,lastName:r,phone:A,email:E===""?null:E,address:h,city:x,state:y,zipCode:j,identificationId:k===""?null:k,notes:g===""?null:g},O=a?`${R}/api/clients/${a.id}`:`${R}/api/clients`,B=a?"PUT":"POST";try{const C=await fetch(O,{method:B,headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(U)});if(!C.ok){const H=await C.json();throw new Error(H.message||`Error HTTP: ${C.status}`)}const q=await C.json();P(a?"Cliente actualizado con éxito!":"Cliente agregado con éxito!"),I.success(a?"Cliente actualizado!":"Cliente agregado!"),u(q),d()}catch(C){console.error("Error al guardar cliente:",C),o(C.message||"Error al guardar el cliente. Intenta de nuevo."),I.error("Ocurrió un error al guardar el cliente.")}finally{t(!1)}};return e.jsxs("div",{className:"client-form-container",children:[e.jsx("h2",{children:a?"Editar Cliente":"Agregar Nuevo Cliente"}),e.jsxs("form",{onSubmit:D,className:"client-form",children:[l&&e.jsx("p",{className:"error-message",children:l}),S&&e.jsx("p",{className:"success-message",children:S}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientName",children:"Nombre:"}),e.jsx("input",{type:"text",id:"clientName",value:m,onChange:s=>i(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientLastName",children:"Apellido:"}),e.jsx("input",{type:"text",id:"clientLastName",value:r,onChange:s=>v(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientPhone",children:"Teléfono:"}),e.jsx("input",{type:"text",id:"clientPhone",value:A,onChange:s=>b(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientEmail",children:"Email:"}),e.jsx("input",{type:"email",id:"clientEmail",value:E,onChange:s=>N(s.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientAddress",children:"Dirección:"}),e.jsx("input",{type:"text",id:"clientAddress",value:h,onChange:s=>w(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientCity",children:"Ciudad:"}),e.jsx("input",{type:"text",id:"clientCity",value:x,onChange:s=>p(s.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientState",children:"Estado:"}),e.jsx("input",{type:"text",id:"clientState",value:y,onChange:s=>_(s.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientZipCode",children:"C.P.:"}),e.jsx("input",{type:"text",id:"clientZipCode",value:j,onChange:s=>$(s.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientIdentificationId",children:"ID de Identificación:"}),e.jsx("input",{type:"text",id:"clientIdentificationId",value:k,onChange:s=>F(s.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"clientNotes",children:"Notas:"}),e.jsx("textarea",{id:"clientNotes",value:g,onChange:s=>f(s.target.value)})]}),e.jsx("button",{type:"submit",disabled:L,children:L?"Guardando...":a?"Actualizar Cliente":"Agregar Cliente"}),a&&e.jsx("button",{type:"button",onClick:d,disabled:L,className:"cancel-button",children:"Cancelar Edición"})]})]})}function M({clients:u,onEditClient:a,onDeleteClient:c,userRole:m}){const i=r=>m?Array.isArray(r)?r.includes(m):m===r:!1;return u.length===0?e.jsx("p",{children:"No hay clientes registrados."}):e.jsxs("div",{className:"client-list-container",children:[e.jsx("h2",{children:"Clientes Registrados"}),e.jsxs("table",{className:"client-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Apellido"}),e.jsx("th",{children:"Teléfono"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Dirección"}),e.jsx("th",{children:"ID Identificación"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:u.map(r=>e.jsxs("tr",{children:[e.jsx("td",{children:r.id}),e.jsx("td",{children:r.name}),e.jsx("td",{children:r.lastName}),e.jsx("td",{children:r.phone}),e.jsx("td",{children:r.email||"N/A"}),e.jsx("td",{children:`${r.address}, ${r.city}`}),e.jsx("td",{children:r.identificationId||"N/A"}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons",children:[i(["super_admin","regular_admin","sales_admin"])&&e.jsx("button",{onClick:()=>a(r),children:"Editar"}),i(["super_admin","regular_admin","sales_admin"])&&e.jsxs(e.Fragment,{children:[e.jsx(z,{to:`/admin/clients/payments/${r.id}`,className:"button-as-link",children:"Gestionar Cobranza"}),e.jsx(z,{to:`/admin/clients/statement/${r.id}`,className:"button-as-link",children:"Ver Estado Cuenta"})]}),i("super_admin")&&e.jsx("button",{className:"delete-button",onClick:()=>c(r.id),children:"Eliminar"})]})})]},r.id))})]})]})}const G="https://cel1.onrender.com";function V({authenticatedFetch:u,onDeleteClient:a,userRole:c}){const[m,i]=n.useState([]),[r,v]=n.useState(!0),[A,b]=n.useState(null),[E,N]=n.useState(null),[h,w]=n.useState(""),[x,p]=n.useState(1),[y,_]=n.useState(10),[j,$]=n.useState(1),[k,F]=n.useState(0),g=t=>{let l=!1;return c?Array.isArray(t)?l=t.includes(c):l=c===t:l=!1,l},f=n.useCallback(async()=>{v(!0),b(null);try{let t=`${G}/api/clients`;h&&(t+=`?search=${encodeURIComponent(h)}`),t+=`${h?"&":"?"}page=${x}&limit=${y}`;const l=await u(t);if(!l.ok){const S=await l.json();throw new Error(S.message||`Error HTTP: ${l.status}`)}const o=await l.json();i(o.clients||[]),$(o.totalPages),F(o.totalItems)}catch(t){console.error("Error al obtener clientes:",t),b(t.message||"No se pudieron cargar los clientes."),i([])}finally{v(!1)}},[u,h,x,y]);n.useEffect(()=>{f()},[f]);const L=async()=>{if(!g(["super_admin","regular_admin","sales_admin"])){I.error("No tienes permisos para exportar clientes.");return}try{I.info("Generando archivo Excel de clientes...");const t=await u(`${G}/api/clients/export-excel`,{method:"GET",headers:{}});if(!t.ok){const D=await t.json();throw new Error(D.message||`Error HTTP: ${t.status}`)}const l=t.headers.get("Content-Disposition");let o="clientes.xlsx";if(l&&l.indexOf("attachment")!==-1){const s=/filename\*?=(?:UTF-8''|\w*')?((['"]).*?\2|[^;\n]*)/.exec(l);if(s!=null&&s[1])try{o=decodeURIComponent(s[1].replace(/['"]/g,""))}catch(U){console.warn("Could not decode filename, using default.",U)}}const S=await t.blob(),P=window.URL.createObjectURL(S),d=document.createElement("a");d.href=P,d.download=o,document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(P),I.success("Archivo Excel exportado con éxito!")}catch(t){console.error("Error al exportar clientes a Excel:",t),I.error(`Error al exportar clientes: ${t.message||"Error desconocido."}`)}};return e.jsxs("section",{className:"clients-section",children:[e.jsx("h2",{children:"Gestión de Clientes"}),g(["super_admin","regular_admin","sales_admin"])&&e.jsx(Z,{onClientAdded:f,clientToEdit:E,setClientToEdit:N}),e.jsxs("div",{className:"admin-controls",children:[e.jsxs("div",{className:"control-group",children:[e.jsx("label",{htmlFor:"searchClient",children:"Buscar Cliente:"}),e.jsx("input",{type:"text",id:"searchClient",value:h,onChange:t=>{w(t.target.value),p(1)},placeholder:"Buscar por nombre, apellido, teléfono, email, ID..."})]}),e.jsxs("div",{className:"control-group",children:[e.jsx("label",{htmlFor:"itemsPerPage",children:"Ítems por página:"}),e.jsxs("select",{id:"itemsPerPage",value:y,onChange:t=>{_(parseInt(t.target.value,10)),p(1)},children:[e.jsx("option",{value:"5",children:"5"}),e.jsx("option",{value:"10",children:"10"}),e.jsx("option",{value:"20",children:"20"}),e.jsx("option",{value:"50",children:"50"})]})]}),g(["super_admin","regular_admin","sales_admin"])&&e.jsx("div",{className:"control-group",children:e.jsx("button",{onClick:L,className:"action-button primary-button",children:"Exportar a Excel"})})]}),r?e.jsx("p",{children:"Cargando clientes..."}):A?e.jsxs("p",{style:{color:"red",fontWeight:"bold"},children:["Error: ",A]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{clients:m,onEditClient:N,onDeleteClient:a,userRole:c}),j>1&&e.jsxs("div",{className:"pagination-controls",children:[e.jsx("button",{onClick:()=>p(t=>Math.max(t-1,1)),disabled:x===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",x," de ",j," (",k," ítems)"]}),e.jsx("button",{onClick:()=>p(t=>Math.min(t+1,j)),disabled:x===j,children:"Siguiente"})]})]})]})}export{V as default};
