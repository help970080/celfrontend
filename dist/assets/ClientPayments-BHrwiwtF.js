import{u as ae,r as a,y as d,j as e}from"./index-D3s1T9TP.js";import{d as k,u as ne,t as te}from"./timezone-D8uTpChD.js";import re from"./ReceiptViewer-BHuPhGRH.js";import"./jspdf.es.min-zq-KNx7Z.js";k.extend(ne);k.extend(te);const oe="America/Mexico_City";function me({authenticatedFetch:l,userRole:g}){const{clientId:O}=ae(),[c,X]=a.useState(null),[A,V]=a.useState([]),[B,w]=a.useState(!0),[D,E]=a.useState(null),[n,v]=a.useState(null),[z,C]=a.useState(!1),[h,x]=a.useState(""),[j,y]=a.useState("cash"),[f,b]=a.useState(""),[S,P]=a.useState(!1),[M,o]=a.useState(null),[H,R]=a.useState(!1),[F,L]=a.useState(null),[m,U]=a.useState(null),[Y,I]=a.useState(!0),[T,$]=a.useState(null),q=s=>g?Array.isArray(s)?s.includes(g):g===s:!1,N=a.useCallback(async()=>{w(!0),E(null),I(!0),$(null);try{const s=await l('<span class="math-inline">{API_BASE_URL}/api/clients/</span>{clientId}');if(!s.ok){const i=await s.json();throw new Error(i.message||`Error HTTP: ${s.status}`)}const r=await s.json();X(r);const t=await l('<span class="math-inline">{API_BASE_URL}/api/reports/client-statement/</span>{clientId}');if(!t.ok){const i=await t.json();throw new Error(i.message||`Error HTTP: ${t.status}`)}const ee=(await t.json()).sales.filter(i=>i.isCredit);V(ee);const p=await l('<span class="math-inline">{API_BASE_URL}/api/reports/client-risk/</span>{clientId}');if(!p.ok){const i=await p.json();throw new Error(i.message||`Error HTTP: ${p.status}`)}const se=await p.json();U(se)}catch(s){console.error("Error al cargar datos del cliente o análisis de riesgo:",s),E(s.message||"No se pudieron cargar los datos del cliente o el análisis de riesgo."),$(s.message||"No se pudo cargar el análisis de riesgo.")}finally{w(!1),I(!1)}},[O,l]);a.useEffect(()=>{N()},[N]);const J=s=>{v(s),C(!0),x(s.weeklyPaymentAmount>0?s.weeklyPaymentAmount.toFixed(2):""),y("cash"),b(""),o(null)},u=()=>{v(null),C(!1),G(),N()},G=()=>{x(""),y("cash"),b(""),P(!1),o(null)},W=a.useCallback(async s=>{if(s.preventDefault(),!n||!n.id){o("No se ha proporcionado una venta válida para registrar el pago."),d.error("Error: Venta inválida para pago.");return}const r=parseFloat(h);if(isNaN(r)||r<=0){o("Por favor, ingresa un monto de pago válido mayor a cero."),d.error("Monto de pago inválido.");return}if(r>n.balanceDue){o(`El monto del pago ($${r.toLocaleString("es-MX",{minimumFractionDigits:2})}) no puede ser mayor al saldo pendiente de $${n.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2})}.`),d.error("Monto de pago excede el saldo pendiente.");return}P(!0),o(null);try{const t=await l('<span class="math-inline">{API_BASE_URL}/api/sales/</span>{selectedSaleForPayment.id}/payments',{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:r,paymentMethod:j,notes:f})});if(!t.ok){const _=await t.json();throw new Error(_.message||`Error HTTP: ${t.status}`)}d.success("Pago registrado con éxito!"),u()}catch(t){console.error("Error al registrar pago:",t),o(t.message||"Error al registrar el pago. Intenta de nuevo."),d.error("Ocurrió un error al registrar el pago.")}finally{P(!1)}},[n,h,j,f,l,u]),Z=s=>{L(s),R(!0)},K=()=>{L(null),R(!1)};if(B)return e.jsx("section",{className:"client-payments-section",children:"Cargando cobranza y análisis de riesgo del cliente..."});if(D)return e.jsx("section",{className:"client-payments-section",children:e.jsxs("p",{className:"error-message",children:["Error: ",D]})});if(!c)return e.jsx("section",{className:"client-payments-section",children:e.jsx("p",{children:"Cliente no encontrado."})});const Q=s=>{switch(s){case"BAJO":return"risk-badge risk-low";case"MEDIO":return"risk-badge risk-medium";case"ALTO":return"risk-badge risk-high";default:return"risk-badge risk-unknown"}};return e.jsxs("section",{className:"client-payments-section",children:[e.jsxs("h2",{children:["Gestión de Cobranza para ",c.name," ",c.lastName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Teléfono:"})," ",c.phone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",c.email||"N/A"]}),e.jsx("hr",{}),e.jsx("h3",{children:"Análisis de Riesgo de Crédito:"}),Y?e.jsx("p",{children:"Cargando análisis de riesgo..."}):T?e.jsxs("p",{className:"error-message",children:["Error al cargar riesgo: ",T]}):m?e.jsxs("div",{className:"risk-analysis-card",children:[e.jsxs("p",{children:["Categoría de Riesgo: ",e.jsx("span",{className:Q(m.riskCategory),children:m.riskCategory})]}),e.jsx("p",{children:m.riskDetails})]}):e.jsx("p",{children:"No se pudo realizar el análisis de riesgo."}),e.jsx("hr",{}),e.jsx("h3",{children:"Historial de Ventas a Crédito:"}),A.length===0?e.jsx("p",{children:"Este cliente no tiene ventas a crédito registradas."}):e.jsx("div",{className:"credit-sales-list",children:A.map(s=>e.jsxs("div",{className:"credit-sale-card",children:[e.jsxs("h4",{children:["Venta #",s.id," - ",k(s.saleDate).tz(oe).format("DD/MM/YYYY")]})," ",e.jsxs("p",{children:[e.jsx("strong",{children:"Producto(s):"})," ",s.saleItems&&s.saleItems.map(r=>r.product?'<span class="math-inline">{item.product.name} (x</span>{item.quantity})':'Producto ID <span class="math-inline">{item.productId} (x</span>{item.quantity})').join(", ")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Monto Original:"})," $",s.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Enganche:"})," $",s.downPayment.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{className:s.balanceDue>0?"highlight-balance":"",children:[e.jsx("strong",{children:"Saldo Pendiente:"})," $",s.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2}),s.balanceDue<=0&&e.jsx("span",{style:{color:"green",marginLeft:"5px",fontWeight:"bold"},children:"(Pagada)"})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Pago Semanal:"})," $",s.weeklyPaymentAmount.toLocaleString("es-MX",{minimumFractionDigits:2})," (",s.numberOfPayments," pagos)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Tasa Interés:"})," ",s.interestRate*100,"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Estado:"})," ",e.jsx("span",{className:`status-badge status-${s.status}`,children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"card-actions",children:[s.balanceDue>0&&s.status!=="paid_off"&&q(["super_admin","regular_admin","sales_admin"])&&e.jsx("button",{onClick:()=>J(s),className:"action-button",children:"Registrar Abono"}),e.jsx("button",{onClick:()=>Z(s),className:"action-button secondary-button",children:"Ver Recibo"})]})]},s.id))}),z&&n&&e.jsx("div",{className:"payment-form-modal-overlay",children:e.jsxs("div",{className:"payment-form-modal-content",children:[e.jsx("button",{className:"close-button",onClick:u,children:"×"}),e.jsxs("h3",{children:["Registrar Abono para Venta #",n.id]}),e.jsxs("div",{className:"payment-summary-info",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Saldo Venta Original:"})," $",n.totalAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]}),e.jsxs("p",{className:"highlight-balance",children:[e.jsx("strong",{children:"Saldo Pendiente:"})," $",n.balanceDue.toLocaleString("es-MX",{minimumFractionDigits:2})]}),n.weeklyPaymentAmount>0&&e.jsxs("p",{children:[e.jsx("strong",{children:"Pago Semanal Sugerido:"})," $",n.weeklyPaymentAmount.toLocaleString("es-MX",{minimumFractionDigits:2})]})]}),e.jsxs("form",{onSubmit:W,className:"payment-form-inner",children:[M&&e.jsx("p",{className:"error-message",children:M}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"abonoAmount",children:"Monto del Abono:"}),e.jsx("input",{type:"number",id:"abonoAmount",value:h,onChange:s=>x(s.target.value),step:"0.01",min:"0.01",max:n.balanceDue,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"abonoMethod",children:"Método de Pago:"}),e.jsxs("select",{id:"abonoMethod",value:j,onChange:s=>y(s.target.value),children:[e.jsx("option",{value:"cash",children:"Efectivo"}),e.jsx("option",{value:"transfer",children:"Transferencia"}),e.jsx("option",{value:"card",children:"Tarjeta"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"abonoNotes",children:"Notas (Opcional):"}),e.jsx("input",{type:"text",id:"abonoNotes",value:f,onChange:s=>b(s.target.value)})]}),e.jsx("button",{type:"submit",disabled:S,children:S?"Registrando...":"Confirmar Abono"}),e.jsx("button",{type:"button",onClick:u,disabled:S,className:"cancel-button",children:"Cancelar"})]})]})}),H&&F&&e.jsx(re,{sale:F,onClose:K})]})}export{me as default};
