<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atrapa los Celulares</title>

  <!-- CSP amplia para iframes en Render/Vite -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data: blob:;
                 img-src 'self' data: blob:;
                 script-src 'self' 'unsafe-inline' 'unsafe-eval';
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self';
                 frame-ancestors *;">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root { --bg1:#667eea; --bg2:#764ba2; --ink:#1f2251; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      height:100vh; display:flex; justify-content:center; align-items:center; overflow:hidden;
    }
    #gameContainer {
      width: 90%; max-width: 800px; height: 600px;
      background:#fff; border-radius:20px; position:relative; overflow:hidden;
      box-shadow:0 18px 50px rgba(0,0,0,.25);
    }

    /* HUD fijo ‚Äì SIN overlays */
    #hud {
      position:absolute; inset:0 0 auto 0; height:64px; display:flex; align-items:center;
      padding:10px 12px; gap:10px; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      z-index:5; border-bottom:1px solid rgba(0,0,0,.06);
    }
    .pill {
      background: rgba(102,126,234,.12); color:var(--ink); border:1px solid rgba(102,126,234,.25);
      padding:8px 12px; border-radius:12px; font-weight:700; font-size:14px;
    }
    .spacer { flex:1; }
    .btn {
      border:0; border-radius:12px; padding:10px 16px; font-weight:800; cursor:pointer; font-size:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.12); transition:transform .15s ease;
    }
    .btn:active { transform:translateY(1px); }
    .btn-start { background:linear-gradient(135deg,#f093fb,#f5576c); color:#fff; }
    .btn-restart { background:#eef1ff; color:#3a3f8a; border:1px solid #dadfff; }

    #gameCanvas { width:100%; height:100%; display:block; outline:none; }

    /* Mini ayuda en la esquina (no tapa) */
    #help {
      position:absolute; right:10px; bottom:10px; z-index:4;
      background:rgba(0,0,0,.55); color:#fff; font-size:12px; padding:7px 10px; border-radius:10px;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <div id="hud" role="toolbar" aria-label="Controles del juego">
      <div class="pill">üì± Puntuaci√≥n: <span id="score">0</span></div>
      <div class="pill">‚ù§Ô∏è Vidas: <span id="lives">3</span></div>
      <div class="spacer"></div>
      <button id="startBtn" class="btn btn-start" type="button">INICIAR</button>
      <button id="restartBtn" class="btn btn-restart" type="button">Reiniciar</button>
    </div>

    <canvas id="gameCanvas" tabindex="0" aria-label="√Årea del juego"></canvas>

    <div id="help">‚Üê ‚Üí o arrastra con el mouse/touch</div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Estado
    let running = false;
    let score = 0, lives = 3;
    const basket = { x:0, y:0, w:80, h:60, speed:8 };
    let phones = [];
    let particles = [];
    const keys = {};
    let mouseX = 0;
    let lastSpawn = 0, spawnRate = 1200, difficulty = 1;
    let raf = null;

    // UI
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');

    function resize() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      basket.y = canvas.height - basket.h - 20;
      if (!running) basket.x = canvas.width/2 - basket.w/2;
    }
    resize();
    addEventListener('resize', resize);

    // Controles
    document.addEventListener('keydown', e => { keys[e.key] = true; if (e.key === 'Enter') toggleStart(); });
    document.addEventListener('keyup',   e => { keys[e.key] = false; });
    canvas.addEventListener('mousemove', e => { const r=canvas.getBoundingClientRect(); mouseX = e.clientX - r.left; });
    canvas.addEventListener('touchmove', e => { e.preventDefault(); const r=canvas.getBoundingClientRect(); mouseX = e.touches[0].clientX - r.left; }, {passive:false});

    startBtn.addEventListener('click', toggleStart);
    restartBtn.addEventListener('click', resetGame);

    function toggleStart(){
      if (running) { // pausar
        running = false;
        if (raf) cancelAnimationFrame(raf), raf=null;
        startBtn.textContent = 'INICIAR';
      } else {
        if (lives <= 0) resetGame(); // si estaba en 0, reinicia
        running = true;
        startBtn.textContent = 'PAUSAR';
        canvas.focus();
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(loop);
      }
    }

    function resetGame(){
      running = false;
      if (raf) cancelAnimationFrame(raf), raf=null;
      score = 0; lives = 3; phones = []; particles = []; difficulty = 1; spawnRate = 1200; lastSpawn = 0;
      basket.x = canvas.width/2 - basket.w/2; mouseX = basket.x + basket.w/2;
      updateHUD();
      startBtn.textContent = 'INICIAR';
      draw(); // limpia pantalla
    }

    function updateHUD(){ scoreEl.textContent = score; livesEl.textContent = lives; }

    function spawn(ts){
      if (ts - lastSpawn > spawnRate){
        const bad = Math.random() < 0.2;
        phones.push({
          x: Math.random()*(canvas.width - 40) + 20, y:-50, w:40, h:60,
          v: 2 + difficulty*0.5, bad,
          rot:0, rots:(Math.random()-0.5)*0.1
        });
        lastSpawn = ts;
        if (score>0 && score%10===0){ spawnRate = Math.max(600, spawnRate-50); difficulty += .2; }
      }
    }

    function updateBasket(){
      if (keys['ArrowLeft'] || keys['a'] || keys['A']) basket.x -= basket.speed;
      if (keys['ArrowRight']|| keys['d'] || keys['D']) basket.x += basket.speed;
      if (mouseX>0) basket.x += (mouseX - (basket.x + basket.w/2)) * 0.15;
      basket.x = Math.max(0, Math.min(canvas.width - basket.w, basket.x));
    }

    function updatePhones(){
      for (let i=phones.length-1;i>=0;i--){
        const p = phones[i];
        p.y += p.v; p.rot += p.rots;

        // colisi√≥n
        if (p.y + p.h >= basket.y && p.y <= basket.y + basket.h &&
            p.x + p.w >= basket.x && p.x <= basket.x + basket.w){
          if (p.bad){ lives--; boom(p.x,p.y); }
          else { score++; spark(p.x,p.y); }
          phones.splice(i,1); updateHUD();
          if (lives<=0){ running=false; startBtn.textContent='INICIAR'; }
          continue;
        }

        // fuera de pantalla
        if (p.y > canvas.height){
          if (!p.bad){ lives--; updateHUD(); if (lives<=0){ running=false; startBtn.textContent='INICIAR'; } }
          phones.splice(i,1);
        }
      }
    }

    function spark(x,y){ for(let i=0;i<5;i++){ const a=2*Math.PI*i/5; particles.push({x,y,vx:Math.cos(a)*3,vy:Math.sin(a)*3,life:20,type:'star'});} }
    function boom(x,y){ for(let i=0;i<8;i++){ const a=2*Math.PI*i/8; particles.push({x,y,vx:Math.cos(a)*4,vy:Math.sin(a)*4,life:15,type:'expl'});} }
    function updParticles(){ for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; if(--p.life<=0) particles.splice(i,1);} }

    function draw(){
      ctx.fillStyle='#f0f4ff'; ctx.fillRect(0,0,canvas.width,canvas.height);

      // canasta
      ctx.fillStyle='#667eea'; ctx.fillRect(basket.x,basket.y,basket.w,basket.h);
      ctx.fillStyle='#4c5fd7'; ctx.fillRect(basket.x,basket.y,basket.w,10);
      ctx.fillRect(basket.x,basket.y,5,basket.h);
      ctx.fillRect(basket.x + basket.w - 5,basket.y,5,basket.h);

      // tel√©fonos
      for(const p of phones){
        ctx.save(); ctx.translate(p.x + p.w/2, p.y + p.h/2); ctx.rotate(p.rot);
        if (p.bad){
          ctx.fillStyle='#ff4757'; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
          ctx.fillStyle='#fff'; ctx.font='30px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText('üí•',0,0);
        } else {
          ctx.fillStyle='#2d3436'; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
          ctx.fillStyle='#4facfe'; ctx.fillRect(-p.w/2+3,-p.h/2+8,p.w-6,p.h-16);
          ctx.fillStyle='#fff'; ctx.font='24px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText('üì±',0,0);
        }
        ctx.restore();
      }

      // part√≠culas
      for(const q of particles){
        ctx.save(); ctx.globalAlpha = (q.type==='star'? q.life/20 : q.life/15);
        if (q.type==='star'){ ctx.fillStyle='#ffd700'; ctx.beginPath(); ctx.arc(q.x,q.y,4,0,Math.PI*2); ctx.fill(); }
        else { ctx.fillStyle='#ff4757'; ctx.fillRect(q.x-3,q.y-3,6,6); }
        ctx.restore();
      }
    }

    function loop(ts=0){
      if (!running) { draw(); return; }
      spawn(ts); updateBasket(); updatePhones(); updParticles(); draw();
      raf = requestAnimationFrame(loop);
    }

    // Estado inicial visible y funcional
    resetGame();
  </script>
</body>
</html>
