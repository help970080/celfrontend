<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Atrapa las Paqueter√≠as</title>
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self' data: blob:;
               img-src 'self' data: blob:;
               script-src 'self' 'unsafe-inline' 'unsafe-eval';
               style-src 'self' 'unsafe-inline';
               connect-src 'self';
               frame-ancestors *;">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{--bg1:#667eea;--bg2:#764ba2;--ink:#1f2251}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden}
  #gameContainer{width:90%;max-width:800px;height:600px;background:#fff;border-radius:20px;position:relative;overflow:hidden;box-shadow:0 18px 50px rgba(0,0,0,.25)}

  /* HUD */
  #hud{position:absolute;inset:0 0 auto 0;height:64px;display:flex;align-items:center;padding:10px 12px;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.85));z-index:5;border-bottom:1px solid rgba(0,0,0,.06)}
  .pill{background:rgba(102,126,234,.12);color:var(--ink);border:1px solid rgba(102,126,234,.25);padding:8px 12px;border-radius:12px;font-weight:700;font-size:14px}
  .spacer{flex:1}
  .btn{border:0;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer;font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);transition:transform .15s ease}
  .btn:active{transform:translateY(1px)}
  .btn-start{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff}
  .btn-restart{background:#eef1ff;color:#3a3f8a;border:1px solid #dadfff}

  #gameCanvas{width:100%;height:100%;display:block;outline:none}
  #help{position:absolute;right:10px;bottom:10px;z-index:4;background:rgba(0,0,0,.55);color:#fff;font-size:12px;padding:7px 10px;border-radius:10px}

  /* Publicidad / Game Over overlay */
  #adOverlay{position:absolute;inset:0;z-index:10;background:radial-gradient(1200px 600px at 50% -200px,rgba(255,255,255,.95),rgba(0,0,0,.75));display:flex;align-items:center;justify-content:center;padding:18px}
  .ad-card{width:min(680px,92%);color:#1b1b1b;background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.25),0 2px 0 rgba(255,255,255,.6) inset;padding:22px 20px;text-align:center;backdrop-filter:blur(6px)}
  .ad-title{font-weight:900;font-size:28px;color:#252a72;letter-spacing:.3px}
  .ad-sub{margin-top:6px;font-size:15px;color:#4d4d6a}
  .ad-grid{margin:16px auto 14px;display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
  .ad-item{border-radius:12px;padding:14px 10px;color:#fff;font-weight:900;font-size:18px;box-shadow:0 10px 24px rgba(0,0,0,.15);text-shadow:0 1px 0 rgba(0,0,0,.2)}
  .dhl{background:#ffcc00;color:#1a1a1a}.estafeta{background:#e30613}.ups{background:#351c15;color:#f2a900}
  .ad-note{font-size:13px;color:#5a5f96;margin-top:4px}
  .ad-cta{margin-top:14px;display:flex;gap:10px;justify-content:center;align-items:center}
  .count-pill{background:#eef1ff;border:1px solid #d7dcff;color:#2e348a;padding:8px 12px;border-radius:999px;font-weight:800;font-size:14px;min-width:110px}
  .ad-btn{border:0;border-radius:12px;padding:12px 18px;font-weight:900;font-size:15px;background:linear-gradient(135deg,#8ec5fc,#e0c3fc);color:#272557;cursor:not-allowed;opacity:.65;box-shadow:0 10px 28px rgba(0,0,0,.18);transition:opacity .2s ease,transform .12s ease}
  .ad-btn.enabled{cursor:pointer;opacity:1;background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff}
  .ad-btn.enabled:active{transform:translateY(1px)}

  /* Al ocultarse no tapa ni captura eventos */
  .hidden{display:none !important}
</style>
</head>
<body>
<div id="gameContainer">
  <!-- HUD -->
  <div id="hud" role="toolbar" aria-label="Controles del juego">
    <div class="pill">üì¶ Puntuaci√≥n: <span id="score">0</span></div>
    <div class="pill">‚ù§Ô∏è Vidas: <span id="lives">3</span></div>
    <div class="spacer"></div>
    <button id="startBtn" class="btn btn-start" type="button">INICIAR</button>
    <button id="restartBtn" class="btn btn-restart" type="button">Reiniciar</button>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas" tabindex="0" aria-label="√Årea del juego"></canvas>
  <div id="help">‚Üê ‚Üí o arrastra con el mouse/touch</div>

  <!-- Publicidad / Game Over -->
  <div id="adOverlay" role="dialog" aria-modal="true" aria-labelledby="ad-title">
    <div class="ad-card">
      <div id="ad-title" class="ad-title">Paqueter√≠a ‚Ä¢ Cr√©dito ‚Ä¢ Env√≠os</div>
      <div id="ad-sub" class="ad-sub">DHL ‚Ä¢ ESTAFETA ‚Ä¢ UPS ‚Ä¢ Semanas y cr√©dito disponibles</div>
      <div id="ad-grid" class="ad-grid" role="list">
        <div class="ad-item dhl" role="listitem">DHL</div>
        <div class="ad-item estafeta" role="listitem">ESTAFETA</div>
        <div class="ad-item ups" role="listitem">UPS</div>
      </div>
      <div id="ad-note" class="ad-note">Atrapa marcas y palabras positivas; evita ‚ÄúMOROSO‚Äù y ‚ÄúPAQUETE ROTO‚Äù.</div>
      <div class="ad-cta">
        <div id="countdown" class="count-pill">Empieza en 5s</div>
        <button id="adStartBtn" class="ad-btn" disabled>JUGAR AHORA</button>
      </div>
    </div>
  </div>
</div>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  // √çtems buenos
  const GOOD_ITEMS = [
    { name:'DHL',      bg:'#ffcc00', fg:'#1a1a1a' },
    { name:'ESTAFETA', bg:'#e30613', fg:'#ffffff' },
    { name:'UPS',      bg:'#351c15', fg:'#f2a900' },
    { name:'LAVADORA', bg:'#12b886', fg:'#ffffff' },
    { name:'CREDITO',  bg:'#2563eb', fg:'#ffffff' },
    { name:'SEMANA',   bg:'#7c3aed', fg:'#ffffff' },
  ];
  // Castigos
  const BAD_ITEMS = [
    { name:'MOROSO',       bg:'#111827', fg:'#ffffff', emoji:'‚õî' },
    { name:'PAQUETE ROTO', bg:'#ff4757', fg:'#ffffff', emoji:'üí•' },
  ];
  const BAD_RATE = 0.22;

  // Estado
  let running = false;
  let score = 0, lives = 3;
  const basket = { x:0, y:0, w:130, h:30, speed:11 };
  let items = [], particles = [];
  const keys = {};
  let mouseX = 0;

  // Dificultad
  let lastSpawn = 0, spawnRate = 850, difficulty = 1;
  let raf = null;

  // UI
  const scoreEl = document.getElementById('score');
  const livesEl = document.getElementById('lives');
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');

  // Overlay
  const adOverlay = document.getElementById('adOverlay');
  const adStartBtn = document.getElementById('adStartBtn');
  const countdownEl = document.getElementById('countdown');
  const adTitleEl = document.getElementById('ad-title');
  const adSubEl = document.getElementById('ad-sub');
  const adNoteEl = document.getElementById('ad-note');
  const adGridEl = document.getElementById('ad-grid');

  // Tama√±o canvas
  function resize(){
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    basket.y = canvas.height - basket.h - 20;
    if (!running) basket.x = canvas.width/2 - basket.w/2;
  }
  resize(); addEventListener('resize', resize);

  // Controles
  document.addEventListener('keydown', e => { keys[e.key] = true; if (e.key === 'Enter') toggleStart(); });
  document.addEventListener('keyup',   e => { keys[e.key] = false; });
  canvas.addEventListener('mousemove', e => { const r=canvas.getBoundingClientRect(); mouseX = e.clientX - r.left; });
  canvas.addEventListener('touchmove', e => { e.preventDefault(); const r=canvas.getBoundingClientRect(); mouseX = e.touches[0].clientX - r.left; }, {passive:false});

  startBtn.addEventListener('click', toggleStart);
  restartBtn.addEventListener('click', resetGame);
  adStartBtn.addEventListener('click', hideOverlayAndStart);

  /* ---------- Overlay logic ---------- */
  function showOverlay(mode, seconds=5, finalScore=0){
    adOverlay.classList.remove('hidden');
    adOverlay.removeAttribute('inert'); adOverlay.setAttribute('aria-hidden','false');

    if (mode === 'intro'){
      adTitleEl.textContent = 'Paqueter√≠a ‚Ä¢ Cr√©dito ‚Ä¢ Env√≠os';
      adSubEl.textContent   = 'DHL ‚Ä¢ ESTAFETA ‚Ä¢ UPS ‚Ä¢ Semanas y cr√©dito disponibles';
      adNoteEl.textContent  = 'Atrapa marcas y palabras positivas; evita ‚ÄúMOROSO‚Äù y ‚ÄúPAQUETE ROTO‚Äù.';
      adGridEl.classList.remove('hidden');
      adStartBtn.textContent = 'JUGAR AHORA';

      let left = seconds;
      countdownEl.textContent = `Empieza en ${left}s`;
      adStartBtn.disabled = true; adStartBtn.classList.remove('enabled');

      const t = setInterval(() => {
        left--;
        if (left>0){ countdownEl.textContent = `Empieza en ${left}s`; }
        else { clearInterval(t); countdownEl.textContent='Listo'; adStartBtn.disabled=false; adStartBtn.classList.add('enabled'); adStartBtn.focus(); }
      },1000);
    } else {
      adTitleEl.textContent = '¬°Juego terminado!';
      adSubEl.textContent   = `Puntuaci√≥n: ${finalScore}`;
      adNoteEl.textContent  = 'Pulsa ‚ÄúJUGAR DE NUEVO‚Äù para intentarlo otra vez.';
      adGridEl.classList.add('hidden');
      countdownEl.textContent = 'Listo';
      adStartBtn.disabled = false; adStartBtn.classList.add('enabled');
      adStartBtn.textContent = 'JUGAR DE NUEVO';
    }
  }

  function hideOverlayAndStart(){
    // Oculta completamente la publicidad
    adOverlay.classList.add('hidden');
    adOverlay.setAttribute('aria-hidden','true');
    try{ adOverlay.setAttribute('inert',''); }catch(_){}

    // ‚úÖ Si venimos de Game Over (vidas 0 o menos), reinicia antes de iniciar
    if (lives <= 0) resetGame();

    // Arranca el loop
    if (!running){
      running = true;
      startBtn.textContent = 'PAUSAR';
      canvas.focus();
      if (raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(loop);
    }
  }
  /* ---------------------------------- */

  // Mostrar intro SOLO cuando termine de cargar
  window.addEventListener('load', () => showOverlay('intro', 5));

  function toggleStart(){
    // Si la publicidad a√∫n est√° visible, primero oc√∫ltala e inicia
    if (!adOverlay.classList.contains('hidden')) { hideOverlayAndStart(); return; }
    if (running){
      running=false; if (raf) cancelAnimationFrame(raf), raf=null; startBtn.textContent='INICIAR';
    } else {
      if (lives<=0) resetGame();
      running=true; startBtn.textContent='PAUSAR'; canvas.focus();
      if (raf) cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
    }
  }

  function resetGame(){
    running=false; if (raf) cancelAnimationFrame(raf), raf=null;
    score=0; lives=3; items=[]; particles=[]; difficulty=1; spawnRate=850; lastSpawn=0;
    basket.x=canvas.width/2 - basket.w/2; mouseX=basket.x + basket.w/2;
    updateHUD(); startBtn.textContent='INICIAR'; draw();
  }

  function updateHUD(){ scoreEl.textContent=score; livesEl.textContent=lives; }

  // Spawner
  function spawn(ts){
    if (ts - lastSpawn > spawnRate){
      const isBad = Math.random() < BAD_RATE;
      let payload;
      if (isBad){
        const bad = BAD_ITEMS[Math.floor(Math.random()*BAD_ITEMS.length)];
        payload = { type:'bad', label:bad.name, bg:bad.bg, fg:bad.fg, emoji:bad.emoji };
      } else {
        const g = GOOD_ITEMS[Math.floor(Math.random()*GOOD_ITEMS.length)];
        payload = { type:'good', label:g.name, bg:g.bg, fg:g.fg };
      }
      items.push({
        x: Math.random()*(canvas.width-160)+80,
        y: -60,
        w: 150,
        h: 48,
        v: 3.2 + difficulty*0.8,
        rot: (Math.random()-0.5)*0.08,
        payload
      });
      lastSpawn = ts;

      if (score>0 && score%7===0){ spawnRate=Math.max(450, spawnRate-40); difficulty+=.25; }
    }
  }

  function updateBasket(){
    if (keys['ArrowLeft']||keys['a']||keys['A']) basket.x -= basket.speed;
    if (keys['ArrowRight']||keys['d']||keys['D']) basket.x += basket.speed;
    if (mouseX>0) basket.x += (mouseX - (basket.x + basket.w/2))*0.20;
    basket.x = Math.max(0, Math.min(canvas.width - basket.w, basket.x));
  }

  function updateItems(){
    for (let i=items.length-1;i>=0;i--){
      const it = items[i];
      it.y += it.v;

      // colisi√≥n
      if (it.y + it.h >= basket.y && it.y <= basket.y + basket.h &&
          it.x + it.w >= basket.x && it.x <= basket.x + basket.w){
        if (it.payload.type==='bad'){ lives--; boom(it.x,it.y); }
        else{ score++; spark(it.x,it.y); }
        items.splice(i,1); updateHUD();
        if (lives<=0){ running=false; startBtn.textContent='INICIAR'; showOverlay('gameover', 0, score); }
        continue;
      }

      // se fue
      if (it.y > canvas.height){
        if (it.payload.type==='good'){ lives--; updateHUD(); if (lives<=0){ running=false; startBtn.textContent='INICIAR'; showOverlay('gameover', 0, score); } }
        items.splice(i,1);
      }
    }
  }

  // Part√≠culas
  function spark(x,y){ for(let i=0;i<6;i++){ const a=2*Math.PI*i/6; particles.push({x,y,vx:Math.cos(a)*3.4,vy:Math.sin(a)*3.4,life:20,type:'star'});} }
  function boom(x,y){ for(let i=0;i<9;i++){ const a=2*Math.PI*i/9; particles.push({x,y,vx:Math.cos(a)*4.5,vy:Math.sin(a)*4.5,life:15,type:'expl'});} }
  function updParticles(){ for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; if(--p.life<=0) particles.splice(i,1);} }

  // Dibujo
  function drawBackground(){ ctx.fillStyle='#f0f4ff'; ctx.fillRect(0,0,canvas.width,canvas.height); }
  function drawBasket(){
    ctx.fillStyle='#667eea'; ctx.fillRect(basket.x,basket.y,basket.w,basket.h);
    ctx.fillStyle='#4c5fd7'; ctx.fillRect(basket.x,basket.y,basket.w,6);
    ctx.fillRect(basket.x,basket.y,4,basket.h);
    ctx.fillRect(basket.x + basket.w - 4,basket.y,4,basket.h);
  }
  function drawItems(){
    for(const it of items){
      ctx.save(); ctx.translate(it.x + it.w/2, it.y + it.h/2); ctx.rotate(it.rot);
      ctx.fillStyle = it.payload.bg; roundRect(-it.w/2,-it.h/2,it.w,it.h,10); ctx.fill();
      ctx.font = (it.payload.type==='good' ? 'bold 22px Arial' : 'bold 18px Arial');
      ctx.fillStyle = it.payload.fg; ctx.textAlign='center'; ctx.textBaseline='middle';
      const label = it.payload.type==='bad' ? `${it.payload.emoji} ${it.payload.label}` : it.payload.label;
      ctx.fillText(label, 0, 2); ctx.restore();
    }
  }
  function drawParticles(){
    for(const q of particles){
      ctx.save(); ctx.globalAlpha = (q.type==='star'? q.life/20 : q.life/15);
      if (q.type==='star'){ ctx.fillStyle='#ffd700'; ctx.beginPath(); ctx.arc(q.x,q.y,4,0,Math.PI*2); ctx.fill(); }
      else { ctx.fillStyle='#ff4757'; ctx.fillRect(q.x-3,q.y-3,6,6); }
      ctx.restore();
    }
  }
  function roundRect(x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2); ctx.beginPath();
    ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath();
  }

  function draw(){ drawBackground(); drawBasket(); drawItems(); drawParticles(); }

  function loop(ts=0){
    if (!running){ draw(); return; }
    spawn(ts); updateBasket(); updateItems(); updParticles(); draw();
    raf = requestAnimationFrame(loop);
  }

  // Estado inicial
  resetGame();
</script>
</body>
</html>
